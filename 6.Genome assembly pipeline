##The following software were used in this pipeline:
- **Jellyfish** (v2.3.0)
- **GenomeScope** (v2.0)
- **CANU** (v2.2)
- **HERA** (v1.0)
- **BWA-MEM**
- **Redundans**
- **Purge Haplotigs**
---
### file: `run_assembly.sh` 
#!/bin/bash
# =========================================================
# Genome Assembly Pipeline 
# Method: PacBio + Illumina + 10X + Hi-C Hybrid Strategy
# =========================================================
# Stop on error
set -e
# ---------------------------------------------------------
# 1. Configuration & Inputs 
# ---------------------------------------------------------
THREADS=40
GENOME_SIZE="390m"
# Input Reads
ILLUMINA_R1="data/illumina_R1.fastq.gz"
ILLUMINA_R2="data/illumina_R2.fastq.gz"
PACBIO_READS="data/pacbio.fastq.gz"
TENX_R1="data/10x_R1.fastq.gz"
TENX_R2="data/10x_R2.fastq.gz"
# Output Directories
OUT_KMER="01_kmer_analysis"
OUT_CANU="02_canu_assembly"
OUT_HERA="03_hera_assembly"
OUT_REDUNDANS="04_redundans"
OUT_PURGE="05_purge_haplotigs"
mkdir -p $OUT_KMER $OUT_CANU $OUT_HERA $OUT_REDUNDANS $OUT_PURGE
# ---------------------------------------------------------
# 2. Genome Survey (K-mer Distribution)
# Tool: Jellyfish v2.3.0, GenomeScope v2.0
# ---------------------------------------------------------
echo "[Step 1] Running K-mer analysis..."
# Count k-mers (K=21 is standard for this genome size)
jellyfish count -C -m 21 -s 10G -t $THREADS -o $OUT_KMER/reads.jf <(zcat $ILLUMINA_R1 $ILLUMINA_R2)
# Export histogram
jellyfish histo -t $THREADS $OUT_KMER/reads.jf > $OUT_KMER/reads.histo
echo "Please run GenomeScope v2.0 using $OUT_KMER/reads.histo"
# ---------------------------------------------------------
# 3. De Novo Assembly
# Tool: CANU v2.2
# ---------------------------------------------------------
echo "[Step 2] Assembling with CANU..."
canu -p 1316 -d $OUT_CANU \
  genomeSize=$GENOME_SIZE \
  useGrid=false \
  maxThreads=$THREADS \
  -pacbio $PACBIO_READS
# ---------------------------------------------------------
# 4. Assembly Improvement
# Tool: HERA v1.0
# Note: HERA is typically used to improve contiguity.
# ---------------------------------------------------------
echo "[Step 3] Running HERA..."
HERA.pl --config config_file --genome $OUT_CANU/1316.contigs.fasta ...
cp $OUT_CANU/1316.contigs.fasta $OUT_HERA/draft_assembly.fasta
# ---------------------------------------------------------
# 5. Heterozygosity Removal - Part 1
# Tool: Redundans
# Params: -identity 0.55, -overlap 0.80, --noscaffolding, -nogapclosing
# ---------------------------------------------------------
echo "[Step 4] Filtering heterozygous sequences with Redundans..."
redundans.py -v -i $ILLUMINA_R1 $ILLUMINA_R2 \
  -f $OUT_HERA/draft_assembly.fasta \
  -o $OUT_REDUNDANS \
  -t 10 \
  -identity 0.55 \
  -overlap 0.80 \
  --noscaffolding \
  --nogapclosing
# The output is typically scaffolds.filled.fa
CURRENT_DRAFT="$OUT_REDUNDANS/scaffolds.filled.fa"

# ---------------------------------------------------------
# 6. Heterozygosity Removal - Part 2
# Tool: Purge Haplotigs
# Process: Align reads -> Histogram -> Purge
# ---------------------------------------------------------
echo "[Step 5] Running Purge Haplotigs..."

# 6.1 Align long reads to the draft assembly using Minimap2 (Preferred for PacBio)
# Note: Text mentions BWA-MEM for "Self-alignment", but read mapping for Purge Haplotigs usually needs mapping reads.
# If you used BWA-MEM for mapping PacBio, replace minimap2 with `bwa mem -x pacbio ...`
minimap2 -t $THREADS -ax map-pb $CURRENT_DRAFT $PACBIO_READS | \
  samtools sort -@ $THREADS -o $OUT_PURGE/aligned.bam -
samtools index $OUT_PURGE/aligned.bam
# 6.2 Create coverage histogram
purge_haplotigs readhist -b $OUT_PURGE/aligned.bam -g $CURRENT_DRAFT -t $THREADS
# 6.3 Calculate coverage stats (You usually need to inspect the histogram manually to set -l, -m, -h)
# Here we assume auto-detection or example values
purge_haplotigs contigcov -i $OUT_PURGE/aligned.bam.gencov -l 5 -m 30 -h 150
# 6.4 Purge haplotigs
purge_haplotigs purge -g $CURRENT_DRAFT -c $OUT_PURGE/coverage_stats.csv -t $THREADS -o $OUT_PURGE/curated
# ---------------------------------------------------------
# 7. Self-Alignment and Merging
# Tool: BWA-MEM
# ---------------------------------------------------------
echo "[Step 6] Final overlap merging using BWA-MEM self-alignment..."

FINAL_CONTIGS="$OUT_PURGE/curated.fasta"

# Self-alignment
bwa index $FINAL_CONTIGS
bwa mem -t $THREADS $FINAL_CONTIGS $FINAL_CONTIGS > $OUT_PURGE/self_alignment.sam

# Note: The actual merging logic based on BWA-MEM self-alignment implies a custom script
# or mapped-based duplication removal. 
# Below is a placeholder for the logic mentioned in the text.
echo "Self-alignment complete. Proceed with custom merging scripts based on self_alignment.sam"

echo "Pipeline finished successfully!"
