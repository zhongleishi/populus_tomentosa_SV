# 4. Genome-Wide Association Study (GWAS) with GEMMA

This document describes a standard GWAS procedure:
1) Convert/filter VCF to PLINK format
2) Compute kinship matrix
3) Run LMM association with GEMMA
4) Extract summary table

---

## Software
- PLINK
- GEMMA
- awk

---

## Inputs
- Genotypes (SV): `all.missing_maf.recode.vcf`
- Phenotype file: (not shown in original commands; GEMMA requires phenotype in `.fam` or separate phenotype input depending on workflow)

## Outputs
- PLINK binary files: `geno0.2maf0.05.*`
- Kinship: `output/kin.sXX.txt`
- Association result: `output/trait1_gemma_lmm4.assoc.txt`
- Simplified summary: `trait1_gemma_lmm4`

---

## Step 1 — Filter and convert VCF to PLINK

```bash
plink --vcf all.vcf \
  --geno 0.2 \
  --maf 0.05 \
  --recode vcf-iid \
  --allow-extra-chr \
  --const-fid \
  --threads 5 \
  --make-bed \
  --out geno0.2maf0.05
```

---

## Step 2 — Compute kinship matrix (GEMMA)

```bash
gemma -bfile geno0.2maf0.05 -gk 2 -o kin
```

- `-gk 2`: centered relatedness matrix

---

## Step 3 — LMM association (example: trait1)

```bash
gemma -bfile geno0.2maf0.05 -k output/kin.sXX.txt -lmm 4 -o trait1_gemma
```

**Important**
- `kin.sXX.txt` filename can differ (GEMMA creates `kin.sXX.txt` where `XX` depends on sample count). Confirm the exact name in `output/`.

---

## Step 4 — Extract key columns for plotting/reporting

```bash
awk 'BEGIN{print "SNP\tCHR\tBP\tP"} NR>1 {print $2"\t"$1"\t"$3"\t"$13}' \
  output/trait1_gemma_lmm4.assoc.txt > trait1_gemma_lmm4
```

**Output columns**
- `SNP`, `CHR`, `BP`, `P` (common format for Manhattan/QQ plotting)
